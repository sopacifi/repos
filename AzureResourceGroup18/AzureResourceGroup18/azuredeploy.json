{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "variables": {
    "app_service_plan_id": "[if(equals(parameters('appServicePlanId'),'null'),concat(resourceGroup().id,'/providers/Microsoft.Web/serverfarms/',variables('app_service_plan_name')), parameters('appServicePlanId'))]",
    "app_service_name": "[parameters('webappName')]",
    "subscription_name": "[subscription().displayName]",
    "ase_name": "[concat(variables('subscription_name'),'-',resourceGroup().location,'-','ase-',parameters('ase_id'))]",
    "app_service_plan_name": "[concat(variables('subscription_name'),'-',resourceGroup().location,'-',parameters('ase_id'),'-',parameters('webappName'))]",
    "ase_rg_name": "[if(equals(parameters('aseResourceGroup'),'null'),concat('base','-',resourceGroup().location,'-','vnet'),parameters('aseResourceGroup'))]"
  },
  "parameters": {
    "webappName": {
      "type": "String",
      "metadata": {
        "description": "The name of the web app that you wish to create."
      }
    },
    "pricingTier": {
      "defaultValue": "1",
      "allowedValues": [
        "1",
        "2",
        "3"
      ],
      "type": "String",
      "metadata": {
        "description": "Defines pricing tier for workers: 1 = Isolated 1, 2 = Isolated 2, 3 = Isolated 3."
      }
    },
    "tagValues": {
      "type": "Object"
    },
    "capacity": {
      "defaultValue": "1",
      "type": "String",
      "metadata": {
        "description": "Defines the number of instances that will be allocated to the app service plan."
      }
    },
    "aseResourceGroup": {
      "defaultValue": "null",
      "type": "String"
    },
    "ase_id": {
      "allowedValues": [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7"
      ],
      "type": "String",
      "metadata": {
        "description": "ASE Identifier for current subscription [1-7]"
      }
    },
    "logLevel": {
      "defaultValue": "Warning",
      "type": "String",
      "metadata": {
        "description": "Level of logging required for the App service, Verbose, Debug, Error."
      }
    },
    "detailedErrorMessages": {
      "defaultValue": false,
      "type": "Bool",
      "metadata": {
        "description": "Enable detailed Error messages - true/false"
      }
    },
    "db_sql_url": {
      "type": "String"
    },
    "nodeVersion": {
      "minLength": 1,
      "defaultValue": "null",
      "type": "String",
      "metadata": {
        "description": "Node Version."
      }
    },
    "appServicePlanId": {
      "defaultValue": "null",
      "type": "String",
      "metadata": {
        "description": "When sharing a plan, set to service plan ID."
      }
    },
    "aseLocation": {
      "defaultValue": "East US 2",
      "type": "String",
      "metadata": {
        "description": "Location of the App Service Environment"
      }
    },
    "javaContainer": {
      "minLength": 1,
      "defaultValue": "TOMCAT",
      "type": "String",
      "metadata": {
        "description": "Container Name."
      }
    },
    "httpLogRetentionInDays": {
      "defaultValue": 5,
      "type": "Int",
      "metadata": {
        "description": "Days to retain log"
      }
    },
    "javaContainerVersion": {
      "minLength": 1,
      "defaultValue": "8.5",
      "type": "String",
      "metadata": {
        "description": "Container Version."
      }
    },
    "httpLogRetentionInMb": {
      "defaultValue": 40,
      "type": "Int",
      "metadata": {
        "description": "Max Log storage in MB"
      }
    },
    "failedRequestsTracing": {
      "defaultValue": false,
      "type": "Bool",
      "metadata": {
        "description": "Enable failed request tracing - true/false"
      }
    },
    "httpLogEnabled": {
      "defaultValue": true,
      "type": "Bool",
      "metadata": {
        "description": "Enable HTTP Logs - true/false"
      }
    },
    "customHostname": {
      "defaultValue": [],
      "type": "Array"
    },
    "javaVersion": {
      "minLength": 1,
      "defaultValue": "1.8",
      "type": "String",
      "metadata": {
        "description": "Java Version."
      }
    }
  },
  "resources": [
    {
      "sku": {
        "tier": "Isolated",
        "capacity": "[int(parameters('capacity'))]",
        "name": "[concat('I',parameters('pricingTier'))]",
        "family": "I",
        "size": "[concat('I',parameters('pricingTier'))]"
      },
      "name": "[variables('app_service_plan_name')]",
      "tags": "[parameters('tagValues')]",
      "apiVersion": "2016-09-01",
      "location": "[parameters('aseLocation')]",
      "type": "Microsoft.Web/serverfarms",
      "properties": {
        "name": "[variables('app_service_plan_name')]",
        "hostingEnvironmentProfile": {
          "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/',variables('ase_rg_name'),'/providers/Microsoft.Web/hostingEnvironments/',variables('ase_name'))]"
        }
      },
      "condition": "[equals(parameters('appServicePlanId'),'null')]"
    },
    {
      "name": "[variables('app_service_name')]",
      "tags": "[parameters('tagValues')]",
      "apiVersion": "2016-08-01",
      "location": "[parameters('aseLocation')]",
      "dependsOn": [
        "[concat('Microsoft.Web/serverFarms/', variables('app_service_plan_name'))]"
      ],
      "identity": {
        "type": "SystemAssigned"
      },
      "type": "Microsoft.Web/sites",
      "properties": {
        "serverFarmId": "[variables('app_service_plan_id')]",
        "name": "[parameters('webappName')]",
        "hostingEnvironmentProfile": {
          "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/',variables('ase_rg_name'),'/providers/Microsoft.Web/hostingEnvironments/',variables('ase_name'))]"
        }
      },
      "resources": [
        {
          "dependsOn": [
            "[resourceId('Microsoft.Web/Sites', variables('app_service_name'))]"
          ],
          "type": "config",
          "properties": {
            "JAVA_OPTS": "[concat(parameters('db_sql_url'),'')]",
            "JDBC_MSI_ENABLE": "true"
          },
          "apiVersion": "2016-03-01",
          "name": "appsettings"
        },
        {
          "dependsOn": [
            "[concat('Microsoft.Web/sites/', variables('app_service_name'))]"
          ],
          "type": "config",
          "properties": {
            "javaContainer": "[parameters('javaContainer')]",
            "alwaysOn": "True",
            "use32BitWorkerProcess": "False",
            "javaContainerVersion": "[parameters('javaContainerVersion')]",
            "defaultDocuments": [
              "index.html"
            ],
            "javaVersion": "[parameters('javaVersion')]"
          },
          "apiVersion": "2016-03-01",
          "name": "web"
        },
        {
          "dependsOn": [
            "[resourceId('Microsoft.Web/Sites', variables('app_service_name'))]"
          ],
          "type": "config",
          "properties": {
            "applicationLogs": {
              "fileSystem": {
                "level": "[parameters('logLevel')]"
              }
            },
            "httpLogs": {
              "fileSystem": {
                "retentionInDays": "[parameters('httpLogRetentionInDays')]",
                "enabled": "[parameters('httpLogEnabled')]",
                "retentionInMb": "[parameters('httpLogRetentionInMb')]"
              }
            },
            "detailedErrorMessages": {
              "enabled": "[parameters('detailedErrorMessages')]"
            },
            "failedRequestsTracing": {
              "enabled": "[parameters('failedRequestsTracing')]"
            }
          },
          "apiVersion": "2016-03-01",
          "name": "logs"
        }
      ]
    }
  ]
}
